<div class="container fully-spaced-row--small" style="--page-container-width: {{ settings.max_page_width | at_most: 1200 }}px;">
  <div class="spaced-row" {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>
    <div class="lightly-spaced-row note">
      <a class="underline" href="{{ routes.account_url }}">{{ 'customer.account.home' | t }}</a>
    </div>

    <h2 class="title align-center">{{ 'customer.order.title' | t: name: order.name }}</h2>
  </div>

  {% if order.cancelled %}
  <div id="order_cancelled" class="errors">
    {% assign date = order.cancelled_at | date: format: 'date' %}
    <h5 id="order_cancelled_title">{{ 'customer.order.cancelled_on' | t: date: date }}</h5>
    <span class="note">{{ 'customer.order.cancelled_reason' | t: reason: order.cancel_reason }}</span>
  </div>
  {% endif %}

  {% assign date = order.created_at | date: format: 'date' %}
  <h3 class="order_date spaced-row">{{ 'customer.order.date' | t: date: date }}</h3>


  <div id="order_address" class="spaced-row" {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>
    <div class="flexible-layout">
      <div id="order_payment" class="column column--half">
        <h5 class="order_section_title">{{ 'customer.order.billing_address' | t }}</h5>
        <p><span class="note">{{ 'customer.order.payment_status' | t }}:</span> <span class="status_{{ order.financial_status }}">{{ order.financial_status_label }}</span></p>
        <div class="address note">
          <p>{{ order.billing_address.name }}</p>
          <p>{{ order.billing_address.company }}</p>
          <p>{{ order.billing_address.street }}</p>
          <p>{{ order.billing_address.city }}, {{ order.billing_address.province }}</p>
          <p>{{ order.billing_address.country }} {{ order.billing_address.zip }}</p>
          <p>{{ order.billing_address.phone }}</p>
        </div>
      </div>
      {% if order.shipping_address %}
        <div id="order_shipping" class="column column--half">
          <h5 class="order_section_title">{{ 'customer.order.shipping_address' | t }}</h5>
          <p><span class="note">{{ 'customer.order.fulfillment_status' | t }}:</span> <span class="status_{{ order.fulfillment_status }}">{{ order.fulfillment_status_label }}</span></p>
          <div class="address note">
            <p>{{ order.shipping_address.name }}</p>
            <p>{{ order.shipping_address.company }}</p>
            <p>{{ order.shipping_address.street }}</p>
            <p>{{ order.shipping_address.city }}, {{ order.shipping_address.province }}</p>
            <p>{{ order.shipping_address.country }} {{ order.shipping_address.zip }}</p>
            <p>{{ order.shipping_address.phone }}</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="order-table-container" {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>
    <table id="order_details" class="order-table">
      <thead>
        <tr>
          <th>{{ 'customer.order.product' | t }}</th>
          <th class="sku">{{ 'customer.order.sku' | t }}</th>
          <th class="price">{{ 'customer.order.price' | t }}</th>
          <th class="quantity align-center">{{ 'customer.order.quantity' | t }}</th>
          <th class="total">{{ 'customer.order.total' | t }}</th>
        </tr>
      </thead>
      <tbody>
        {% for line_item in order.line_items %}
{% comment %} Wholesale_Hub_Line_Item_Prices Start {% endcomment %}
{% if line_item.product %}{% assign base_product = line_item.product %}{% else %}{% assign base_product = line_item %}{% endif %}
{% if line_item.variant %}{% assign base_variant = line_item.variant %}{% else %}{% assign base_variant = line_item.selected_or_first_available_variant %}{% endif %}
{% assign WCNonFractionalCurrencies = "AFN, ALL, BIF, CLP, DJF, GNF, ISK, JPY, KMF, KRW, LAK, LBP, MGA, MMK, PYG, RSD, RWF, SLL, STD, UGX, VND, VUV, XAF, XOF, XPF, YER" | split: ", "%}

{% assign WCCartUsingNonFractionalCurrency = false %}
{% for non_fractional_currency in WCNonFractionalCurrencies %}
  {% if cart.currency.iso_code == non_fractional_currency %}
    {% assign WCCartUsingNonFractionalCurrency = true %}
  {% endif %}
{% endfor %}


{% assign WCCartUsingSecondaryMarketDiscount = false %}
{% unless shop.metafields.sawholesale.primary_market_id == blank %}
  {% if localization.market.id != shop.metafields.sawholesale.primary_market_id %}
    {% assign WCCartUsingSecondaryMarketDiscount = true %}
  {% endif %}
{% endunless%}

{% if shop.metafields.sawholesale['base_price'] == blank %}
  {% assign base_price = 'compare_at_price' %}
{% else %}
  {% assign base_price = shop.metafields.sawholesale['base_price'] %}
{% endif %}

{% assign saw_discount = 0 %}{% assign saw_has_discount = false %}

{% if customer.tags != blank and WCCartUsingSecondaryMarketDiscount == false %}
  {% for mf in base_product.metafields.sawholesale %}
    {% capture product_customer_tag %}{{ mf | first | replace: 'discount_', '' }}{% endcapture %}
    {% if customer.tags contains product_customer_tag %}
      {% assign saw_has_discount = true %}
      {% assign discount_key = product_customer_tag | prepend: 'discount_' %}
      {% assign price_key = product_customer_tag | prepend: 'price_' %}
      {% assign saw_discount = base_product.metafields.sawholesale[discount_key] | divided_by: 100.0 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if customer.tags != blank and WCCartUsingSecondaryMarketDiscount == true %}
  {% for collection in base_product.collections %}
    {% for discount in collection.metafields.sawholesale.discounts.value %}
      {% if customer.tags contains discount.tag %}
        {% assign saw_has_discount = true %}
        {% assign this_discount = discount.discount_percent | divided_by: 100.0 %}
        {% if this_discount > saw_discount %}{% assign saw_discount = this_discount %}{% endif %}
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endif %}

{% comment %}
  Rather than calculating the percentage remaining after a discount the secondary
  markets logic uses the raw discount percentage to calculate the saw_variant_price
  For a 10% discount:
    In the primary market the saw_discount would be: 90%
    In the secondary market the saw_discount would be: 10%
{% endcomment %}
{% unless WCCartUsingSecondaryMarketDiscount %}
  {% assign saw_discount = 1 | minus: saw_discount %}
{% endunless %}

{% if WCCartUsingSecondaryMarketDiscount == true or base_price == 'price' or base_variant.compare_at_price == blank or base_variant.compare_at_price == 0 or base_variant.compare_at_price < base_variant.price %}
  {% assign saw_variant_compare_at_price = base_variant.price %}
{% else %}
  {% assign saw_variant_compare_at_price = base_variant.compare_at_price %}
{% endif %}

{% assign cpe = shop.metafields.sawholesale['cpe'] | default: "true" %}

{% if base_variant.metafields.sawholesale[price_key] != blank and cpe == "true" %}
  {% assign saw_variant_price = base_variant.metafields.sawholesale[price_key] %}
{% else %}
  {% comment %}
    For a 10% discount on a variant price of 100:
      In the primary market the saw_variant_price would be: 100 * 0.90 = 90
      In the secondary market the saw_variant_price would be: 100 * 0.10 = 10
      So saw_variant_price is not made available to the global scope in a secondary
      market. Doing so might cause strange behaviour if not properly accounted for.
  {% endcomment %}
  {% if WCCartUsingSecondaryMarketDiscount %}
    {% assign WCVariant_DiscountAmount = saw_variant_compare_at_price | times: saw_discount %}
  {% else %}
    {% assign saw_variant_price = saw_variant_compare_at_price | times: saw_discount %}
    {% assign WCVariant_DiscountAmount = 0 %}
  {% endif %}
{% endif %}
{% if WCCartUsingSecondaryMarketDiscount %}
  {% if WCCartUsingNonFractionalCurrency %}
    {% assign WCLineItem_DiscountAmount = WCVariant_DiscountAmount | times: line_item.quantity | round %}
  {% else %}
    {% assign WCLineItem_DiscountAmount = WCVariant_DiscountAmount | times: line_item.quantity | floor %}
  {% endif %}
  {% assign WCVariant_Price = saw_variant_compare_at_price %}
{% else %}
  {% comment %}
  For primary markets the discount has already been applied to the WCVariant_Price and it
  will be multiplied by the item quantity (if applicable).
  {% endcomment %}
  {% assign WCLineItem_DiscountAmount = 0 %}
  {% assign WCVariant_Price = saw_variant_price %}
{% endif %}

{% if saw_has_discount == false or saw_variant_price >= saw_variant_compare_at_price %}
  {% assign WCLineItem_OriginalPrice = line_item.original_price %}
  {% assign WCLineItem_FinalPrice = line_item.final_price %}
  {% assign WCLineItem_Price = line_item.price %}
  {% assign WCLineItem_PriceMin = line_item.price_min %}
  {% assign WCLineItem_PriceMax = line_item.price_max %}
  {% assign WCLineItem_CompareAtPrice = line_item.compare_at_price %}
  {% assign WCLineItem_CompareAtPriceMin = line_item.compare_at_price_min %}
  {% assign WCLineItem_CompareAtPriceMax = line_item.compare_at_price_max %}
  {% assign WCLineItem_OriginalLinePrice = line_item.original_line_price %}
  {% assign WCLineItem_FinalLinePrice = line_item.final_line_price %}
  {% assign WCLineItem_LinePrice = line_item.line_price %}
{% else %}
  {% assign WCLineItem_OriginalPrice = saw_variant_compare_at_price %}
  {% assign WCLineItem_FinalPrice = WCVariant_Price | minus: WCVariant_DiscountAmount %}
  {% assign WCLineItem_Price = WCVariant_Price %}
  {% assign WCLineItem_PriceMin = line_item.price_min | times: saw_discount %}
  {% assign WCLineItem_PriceMax = line_item.price_max | times: saw_discount %}
  {% assign WCLineItem_CompareAtPrice = saw_variant_compare_at_price %}
  {% if base_product.compare_at_price_min != 0 %}{% assign WCLineItem_CompareAtPriceMin = base_product.compare_at_price_min %}{% else %}{% assign WCLineItem_CompareAtPriceMin = base_product.price_min %}{% endif %}
  {% if base_product.compare_at_price_max != 0 %}{% assign WCLineItem_CompareAtPriceMax = base_product.compare_at_price_max %}{% else %}{% assign WCLineItem_CompareAtPriceMax = base_product.price_max %}{% endif %}
  {% assign WCLineItem_OriginalLinePrice = WCLineItem_OriginalPrice | round | times: line_item.quantity %}
  {% assign WCLineItem_FinalLinePrice = WCLineItem_Price | round | times: line_item.quantity | minus: WCLineItem_DiscountAmount %}
  {% assign WCLineItem_LinePrice = WCLineItem_Price | round | times: line_item.quantity | minus: WCVariant_DiscountAmount %}
{% endif %}
{% comment %} Wholesale_Hub_Line_Item_Prices End {% endcomment %}

        <tr id="{{ line_item.id }}" class="{% cycle 'odd', 'even' %}">
          <td class="product">
            <a class="text-current font-semibold" href="{{ line_item.url }}">{{ line_item.title }}</a>
            <div class="small-text">
              {% if line_item.product.variants.size > 1 %}
              <div class="variant">{{ line_item.variant.title }}</div>
              {% endif %}

              {%- for p in line_item.properties -%}
                {% unless p.last == blank %}
                  <div class="line-item-property">{{ p.first }}:
                    {% if p.last contains '/uploads/' %}
                    <a href="{{ p.last }}">{{ p.last | split: '/' | last }}</a>
                    {% else %}
                    {{ p.last }}
                    {% endif %}
                  </div>
                {% endunless %}
              {%- endfor -%}
            </div>

            {% if line_item.selling_plan_allocation %}
              <div class="subscription-description small-text">{{ line_item.selling_plan_allocation.selling_plan.name }}</div>
            {% endif %}

            {% if line_item.fulfillment %}
            <div class="info-card">
              {% assign date = line_item.fulfillment.created_at | date: format: "month_date_year" %}
              <span class="block">{{ 'customer.order.fulfilled_on' | t: date: date }}</span>
              {% if line_item.fulfillment.tracking_url %}
                <a class="inline-block underline mt-2" href="{{ line_item.fulfillment.tracking_url }}">
                  {{ 'customer.order.track_shipment' | t }}
                </a>
              {% endif %}
              <span class="block">
                {{ line_item.fulfillment.tracking_company }}
                {%- if line_item.fulfillment.tracking_number %}
                  #{{ line_item.fulfillment.tracking_number }}
                {% endif -%}
              </span>
            </div>
            {% endif %}
          </td>
          <td class="sku note">{{ line_item.sku }}</td>
          <td class="price">
            {% if WCLineItem_OriginalLinePrice > WCLineItem_FinalLinePrice %}
              <div class="struck-out-price">{{ WCLineItem_OriginalPrice | money }}</div>
            {% endif %}
            <div class="product-price">{{ WCLineItem_FinalPrice | money }}</div>

            {% render 'unit-price', variant: line_item %}

            {% if line_item.line_level_discount_allocations.size > 0 %}
              <ul class="cart-discount-list">
              {% for discount_allocation in line_item.line_level_discount_allocations %}
                <li class="cart-discount">
                  <div class="cart-discount__label">
                      <span class="cart-discount__icon">{% render 'icon-label' %}</span>
                      <span class="cart-discount__title">{{ discount_allocation.discount_application.title }}</span>
                  </div>
                  <div class="cart-discount__amount">{{ discount_allocation.amount | money }}</div>
                </li>
              {% endfor %}
              </ul>
            {% endif %}
          </td>
          <td class="quantity align-center">{{ line_item.quantity }}</td>
          <td class="total">
            {% if WCLineItem_OriginalLinePrice != WCLineItem_FinalLinePrice %}
              <div class="struck-out-price">{{ WCLineItem_OriginalLinePrice | money }}</div>
            {% endif %}

            {{ WCLineItem_FinalLinePrice | money }}

            {% if line_item.line_level_discount_allocations.size > 0 %}
              <ul class="cart-discount-list mobile-only">
              {% for discount_allocation in line_item.line_level_discount_allocations %}
                <li class="cart-discount">
                  <div class="cart-discount__label">
                      <span class="cart-discount__icon">{% render 'icon-label' %}</span>
                      <span class="cart-discount__title">{{ discount_allocation.discount_application.title }}</span>
                  </div>
                  <div class="cart-discount__amount">{{ discount_allocation.amount | money }}</div>
                </li>
              {% endfor %}
              </ul>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="order_summary note">
          <td class="label" colspan="4">{{ 'customer.order.subtotal' | t }}:</td>
          <td class="total">{{ order.line_items_subtotal_price | money }}</td>
        </tr>

        {%- if order.cart_level_discount_applications != blank -%}
          {%- for discount_application in order.cart_level_discount_applications -%}
            <tr class="order_summary note cart-discount">
              <td class="cart-discount__label" colspan="4">
                  <span class="cart-discount__icon">{% render 'icon-label' %}</span>
                  <span class="cart-discount__title">{{ discount_application.title }}</span>
              </td>
              <td class="cart-discount__amount">{{ discount_application.total_allocated_amount | money }}</td>
            </tr>
          {%- endfor -%}
        {%- endif -%}

        {% for shipping_method in order.shipping_methods %}
        <tr class="order_summary note">
          <td class="label" colspan="4">{{ 'customer.order.shipping' | t }} ({{ shipping_method.title }}):</td>
          <td class="total">{{ shipping_method.price | money }}</td>
        </tr>
        {% endfor %}

        {% for tax_line in order.tax_lines %}
        <tr class="order_summary note">
          <td class="label" colspan="4">{{ 'customer.order.tax' | t }} ({{ tax_line.title }} {{ tax_line.rate | times: 100 }}%):</td>
          <td class="total">{{ tax_line.price | money }}</td>
        </tr>
        {% endfor %}

        <tr class="order_summary order_total">
          <td class="label" colspan="4">{{ 'customer.order.total' | t }}:</td>
          <td class="total">
            {%- if settings.cart_currency_code_enabled -%}
              {{- order.total_price | money_with_currency -}}
            {%- else -%}
              {{- order.total_price | money -}}
            {%- endif -%}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
